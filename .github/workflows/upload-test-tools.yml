name: Upload Test Tools

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional tag name to create (defaults to v0.0.0-testtools-<timestamp>)'
        required: false

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Determine tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            t="v0.0.0-testtools-$(date -u +%Y%m%d%H%M%S)"
            echo "tag=$t" >> $GITHUB_OUTPUT
          fi
          echo "Using tag: $TAG"

      - name: Get main commit sha
        id: sha
        env:
          TOKEN: ${{ secrets.TEST_UPLOAD_PAT }}
        run: |
          REPO="prideicker/FluentYTDL"
          SHAJ=$(curl -s -H "Authorization: token $TOKEN" "https://api.github.com/repos/$REPO/git/refs/heads/main" | jq -r .object.sha)
          echo "sha=$SHAJ" >> $GITHUB_OUTPUT

      - name: Create tag ref
        env:
          TOKEN: ${{ secrets.TEST_UPLOAD_PAT }}
        run: |
          REPO="prideicker/FluentYTDL"
          TAG="${{ steps.tag.outputs.tag }}"
          SHA="${{ steps.sha.outputs.sha }}"
          echo "Creating tag $TAG -> $SHA"
          curl -s -X POST -H "Authorization: token $TOKEN" -d "{\"ref\":\"refs/tags/$TAG\",\"sha\":\"$SHA\"}" "https://api.github.com/repos/$REPO/git/refs" | jq -r .ref

      - name: Create draft release
        id: release
        env:
          TOKEN: ${{ secrets.TEST_UPLOAD_PAT }}
        run: |
          REPO="prideicker/FluentYTDL"
          TAG="${{ steps.tag.outputs.tag }}"
          RESP=$(curl -s -X POST -H "Authorization: token $TOKEN" -H "Content-Type: application/json" -d "{\"tag_name\":\"$TAG\",\"name\":\"Test Tools $TAG\",\"draft\":true}" "https://api.github.com/repos/$REPO/releases")
          echo "release_id=$(echo $RESP | jq -r .id)" >> $GITHUB_OUTPUT
          echo "upload_url=$(echo $RESP | jq -r .upload_url)" >> $GITHUB_OUTPUT

      - name: Upload asset
        env:
          TOKEN: ${{ secrets.TEST_UPLOAD_PAT }}
        run: |
          UPLOAD_URL="${{ steps.release.outputs.upload_url }}"
          ASSET_PATH=$(ls release/*tools*.zip | head -n1)
          if [ -z "$ASSET_PATH" ]; then echo "No test tools zip found in release/"; exit 1; fi
          ASSET_NAME=$(basename "$ASSET_PATH")
          echo "Uploading $ASSET_NAME to $UPLOAD_URL"
          curl -s -X POST -H "Authorization: token $TOKEN" -H "Content-Type: application/zip" --data-binary @"$ASSET_PATH" "${UPLOAD_URL}?name=$ASSET_NAME" | jq -r .name

      - name: Done
        run: |
          echo "Upload complete. Tag created: ${{ steps.tag.outputs.tag }}. Release created and asset uploaded."