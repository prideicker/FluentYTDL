# ==============================================================================
#  FluentYTDL - GitHub Actions è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ v4
# ==============================================================================
# è§¦å‘æ¡ä»¶:
#   - æ¨é€ v* æ ‡ç­¾æ—¶è‡ªåŠ¨æ„å»ºå‘å¸ƒ (ä¾‹å¦‚ v1.0.18)
#   - æ‰‹åŠ¨è§¦å‘ workflow_dispatch
#
# ç”Ÿæˆç‰ˆæœ¬:
#   1. setup.exe    - Windows å®‰è£…åŒ… (Inno Setup)
#   2. full.7z      - å®Œæ•´ä¾¿æºç‰ˆ (å«å¤–éƒ¨å·¥å…·)
#   3. portable.exe - è½»é‡ä¾¿æºç‰ˆ (å•æ–‡ä»¶ï¼Œä¸å«å¤–éƒ¨å·¥å…·)
# ==============================================================================

name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¸å¸¦ v å‰ç¼€ï¼Œä¾‹å¦‚ 1.0.18)'
        required: false
        default: ''
      targets:
        description: 'æ„å»ºç›®æ ‡'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - setup
          - full
          - portable

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.12'

jobs:
  build-release:
    runs-on: windows-latest
    
    steps:
      # ========================================
      # 1. ç¯å¢ƒå‡†å¤‡
      # ========================================
      - name: "ğŸ“¥ æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬ä¿¡æ¯

      - name: "ğŸ è®¾ç½® Python ${{ env.PYTHON_VERSION }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–"
        shell: pwsh
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install ".[dev]"
          pip install py7zr  # ç”¨äºåˆ›å»º 7z å‹ç¼©åŒ…

      # ========================================
      # 2. ä¸‹è½½å¤–éƒ¨å·¥å…·
      # ========================================
      - name: "ğŸ”§ ä¸‹è½½å¤–éƒ¨å·¥å…· (yt-dlp, ffmpeg, deno, atomicparsley)"
        shell: pwsh
        run: python scripts/fetch_tools.py --force

      # ========================================
      # 3. å®‰è£… Inno Setup (ä½¿ç”¨ Chocolatey)
      # ========================================
      - name: "ğŸ“¦ å®‰è£… Inno Setup"
        shell: pwsh
        run: |
          Write-Host "ä½¿ç”¨ Chocolatey å®‰è£… Inno Setup..."
          choco install innosetup -y --no-progress
          
          # éªŒè¯å®‰è£…
          $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (Test-Path $isccPath) {
            Write-Host "âœ“ Inno Setup å®‰è£…æˆåŠŸ"
          } else {
            Write-Host "âŒ Inno Setup å®‰è£…å¤±è´¥"
            exit 1
          }

      # ========================================
      # 4. ç¡®å®šç‰ˆæœ¬å·
      # ========================================
      - name: "ğŸ”¢ ç¡®å®šç‰ˆæœ¬å·"
        id: version
        shell: pwsh
        run: |
          # ä¼˜å…ˆçº§: æ‰‹åŠ¨è¾“å…¥ > Git æ ‡ç­¾ > pyproject.toml
          $version = ""
          
          # 1. æ£€æŸ¥æ‰‹åŠ¨è¾“å…¥
          if ("${{ github.event.inputs.version }}" -ne "") {
            $version = "${{ github.event.inputs.version }}"
            Write-Host "ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥ç‰ˆæœ¬: $version"
          }
          # 2. æ£€æŸ¥ Git æ ‡ç­¾
          elseif ("${{ github.ref_type }}" -eq "tag") {
            $version = "${{ github.ref_name }}".TrimStart("v")
            Write-Host "ä½¿ç”¨ Git æ ‡ç­¾ç‰ˆæœ¬: $version"
          }
          # 3. ä» pyproject.toml è¯»å–
          else {
            $content = Get-Content pyproject.toml -Raw
            if ($content -match 'version\s*=\s*"([^"]+)"') {
              $version = $matches[1]
              Write-Host "ä½¿ç”¨ pyproject.toml ç‰ˆæœ¬: $version"
            } else {
              $version = "0.0.0"
              Write-Host "ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $version"
            }
          }
          
          Write-Host "æœ€ç»ˆç‰ˆæœ¬å·: $version"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "PACKAGE_VERSION=v$version" >> $env:GITHUB_ENV

      # ========================================
      # 5. æ„å»º
      # ========================================
      - name: "ğŸ”¨ æ„å»ºæ‰€æœ‰ç›®æ ‡"
        if: github.event.inputs.targets == 'all' || github.event.inputs.targets == ''
        shell: pwsh
        run: python scripts/build.py --target all --version "v${{ steps.version.outputs.VERSION }}"

      - name: "ğŸ”¨ æ„å»º Setup"
        if: github.event.inputs.targets == 'setup'
        shell: pwsh
        run: python scripts/build.py --target setup --version "v${{ steps.version.outputs.VERSION }}"

      - name: "ğŸ”¨ æ„å»º Full"
        if: github.event.inputs.targets == 'full'
        shell: pwsh
        run: python scripts/build.py --target full --version "v${{ steps.version.outputs.VERSION }}"

      - name: "ğŸ”¨ æ„å»º Portable"
        if: github.event.inputs.targets == 'portable'
        shell: pwsh
        run: python scripts/build.py --target portable --version "v${{ steps.version.outputs.VERSION }}"

      # ========================================
      # 6. åˆ—å‡ºæ„å»ºäº§ç‰©
      # ========================================
      - name: "ğŸ“‹ åˆ—å‡ºæ„å»ºäº§ç‰©"
        shell: pwsh
        run: |
          Write-Host "=== æ„å»ºäº§ç‰© ===" -ForegroundColor Cyan
          Get-ChildItem -Path release -Recurse | ForEach-Object {
            $size = if ($_.PSIsContainer) { "" } else { "{0:N2} MB" -f ($_.Length / 1MB) }
            Write-Host "  $($_.Name) $size"
          }

      # ========================================
      # 7. ä¸Šä¼  Artifacts (ç”¨äºè°ƒè¯•)
      # ========================================
      - name: "ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: FluentYTDL-v${{ steps.version.outputs.VERSION }}-builds
          path: release/*
          retention-days: 30
          if-no-files-found: error

      # ========================================
      # 8. åˆ›å»º GitHub Release
      # ========================================
      - name: "ğŸš€ åˆ›å»º GitHub Release"
        uses: softprops/action-gh-release@v2
        if: success() && startsWith(github.ref, 'refs/tags/')
        with:
          name: FluentYTDL v${{ steps.version.outputs.VERSION }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
          generate_release_notes: true
          files: |
            release/*.exe
            release/*.7z
            release/SHA256SUMS.txt
          body: |
            ## ğŸ“¦ ä¸‹è½½
            
            | ç‰ˆæœ¬ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
            |------|------|----------|
            | `*-setup.exe` | Windows å®‰è£…åŒ… | æ¨èæ™®é€šç”¨æˆ·ä½¿ç”¨ |
            | `*-full.7z` | ä¾¿æºå®Œæ•´ç‰ˆ | æ— éœ€å®‰è£…ï¼Œè§£å‹å³ç”¨ |
            | `*-portable.exe` | è½»é‡ä¾¿æºç‰ˆ | å•æ–‡ä»¶ï¼Œéœ€è‡ªå¤‡ yt-dlp/ffmpeg |
            
            ## âœ… æ ¡éªŒ
            ä¸‹è½½åè¯·ä½¿ç”¨ `SHA256SUMS.txt` æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§ã€‚
            
            ---
            è‡ªåŠ¨æ„å»ºäº ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}