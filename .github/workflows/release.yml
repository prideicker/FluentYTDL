# ==============================================================================
#  FluentYTDL - 多版本发布流程 (Multi-Build Release Workflow) - v3
# ==============================================================================
# 触发条件: 当一个 'v' 开头的标签 (例如 v1.0.0, v0.2.1)被推送到仓库时
# 生成版本:
# 1. portable   - onedir + full (带工具的便携目录版)
# 2. shell      - onefile + shell (轻量单文件，无外部工具)
# 3. full       - onefile + full (单文件 + 外部工具)
# ==============================================================================

name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    runs-on: windows-latest
    
    steps:
      - name: "[1/8] Checkout Code"
        uses: actions/checkout@v4

      - name: "[2/8] Setup Python with Dependency Cache"
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: "[3/8] Install Dependencies"
        shell: pwsh
        run: |
          pip install --upgrade pip
          pip install ".[dev]"

      - name: "[4/8] Prepare Tools (ffmpeg & yt-dlp)"
        shell: pwsh
        run: .\scripts\fetch_tools.ps1

      - name: "[5/8] Build Portable Version (onedir + full)"
        shell: pwsh
        run: .\scripts\package.ps1 -Mode onedir -Flavor full
        env:
          PACKAGE_VERSION: ${{ github.ref_name }}

      - name: "[6/8] Build Shell Version (onefile + shell)"
        shell: pwsh
        run: .\scripts\package.ps1 -Mode onefile -Flavor shell
        env:
          PACKAGE_VERSION: ${{ github.ref_name }}

      - name: "[7/8] Build Full Single-File Version (onefile + full)"
        shell: pwsh
        run: .\scripts\package.ps1 -Mode onefile -Flavor full
        env:
          PACKAGE_VERSION: ${{ github.ref_name }}

      - name: "[8/8] Create GitHub Release"
        uses: softprops/action-gh-release@v2
        if: success() && startsWith(github.ref, 'refs/tags/')
        with:
          files: release/*.zip
          draft: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}