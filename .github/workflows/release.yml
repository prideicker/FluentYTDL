# ==============================================================================
#  FluentYTDL - GitHub Actions è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ v4
# ==============================================================================
# è§¦å‘æ¡ä»¶:
#   - æ¨é€ v* æ ‡ç­¾æ—¶è‡ªåŠ¨æ„å»ºå‘å¸ƒ (ä¾‹å¦‚ v1.0.18)
#   - æ‰‹åŠ¨è§¦å‘ workflow_dispatch
#
# ç”Ÿæˆç‰ˆæœ¬:
#   1. setup.exe    - Windows å®‰è£…åŒ… (Inno Setup)
#   2. full.7z      - å®Œæ•´ä¾¿æºç‰ˆ (å«å¤–éƒ¨å·¥å…·)
#   3. portable.exe - è½»é‡ä¾¿æºç‰ˆ (å•æ–‡ä»¶ï¼Œä¸å«å¤–éƒ¨å·¥å…·)
# ==============================================================================

name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¸å¸¦ v å‰ç¼€ï¼Œä¾‹å¦‚ 1.0.18)'
        required: false
        default: ''
      targets:
        description: 'æ„å»ºç›®æ ‡'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - setup
          - full
          - portable
      publish:
        description: 'æ˜¯å¦å‘å¸ƒ GitHub Release'
        required: true
        default: false
        type: boolean
      strict_version_check:
        description: 'ä¸¥æ ¼æ ¡éªŒç‰ˆæœ¬ä¸€è‡´æ€§'
        required: true
        default: true
        type: boolean
      run_quality_gates:
        description: 'è¿è¡Œå‘å¸ƒå‰è´¨é‡é—¨æ§› (ruff/pyright)'
        required: true
        default: true
        type: boolean

permissions:
  contents: write

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.version }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.12'

jobs:
  build-release:
    runs-on: windows-latest
    
    steps:
      # ========================================
      # 1. ç¯å¢ƒå‡†å¤‡
      # ========================================
      - name: "ğŸ“¥ æ£€å‡ºä»£ç "
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬ä¿¡æ¯

      - name: "ğŸ è®¾ç½® Python ${{ env.PYTHON_VERSION }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–"
        shell: pwsh
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install ".[dev]"
          pip install py7zr  # ç”¨äºåˆ›å»º 7z å‹ç¼©åŒ…

      - name: "ğŸ” å‘å¸ƒå‰è´¨é‡é—¨æ§› (ruff/pyright)"
        if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_quality_gates == 'true'
        shell: pwsh
        run: |
          ruff check src
          pyright

      # ========================================
      # 2. ä¸‹è½½å¤–éƒ¨å·¥å…·
      # ========================================
      - name: "ğŸ”§ ä¸‹è½½å¤–éƒ¨å·¥å…· (yt-dlp, ffmpeg, deno, atomicparsley)"
        if: github.event_name != 'workflow_dispatch' || github.event.inputs.targets != 'portable'
        shell: pwsh
        run: python scripts/fetch_tools.py --force

      # ========================================
      # 3. å®‰è£… Inno Setup (ä½¿ç”¨ Chocolatey)
      # ========================================
      - name: "ğŸ“¦ å®‰è£… Inno Setup"
        if: github.event_name != 'workflow_dispatch' || github.event.inputs.targets == 'all' || github.event.inputs.targets == 'setup'
        shell: pwsh
        run: |
          Write-Host "ä½¿ç”¨ Chocolatey å®‰è£… Inno Setup..."
          choco install innosetup -y --no-progress
          
          # éªŒè¯å®‰è£…
          $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (Test-Path $isccPath) {
            Write-Host "âœ“ Inno Setup å®‰è£…æˆåŠŸ"
          } else {
            Write-Host "âŒ Inno Setup å®‰è£…å¤±è´¥"
            exit 1
          }

      # ========================================
      # 4. ç¡®å®šç‰ˆæœ¬å·
      # ========================================
      - name: "ğŸ”¢ ç¡®å®šç‰ˆæœ¬å·"
        id: version
        shell: pwsh
        run: |
          $version = ""
          $targets = "all"
          $publish = "false"
          $strict = "true"
          
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $targets = "${{ github.event.inputs.targets }}"
            $publish = "${{ github.event.inputs.publish }}"
            $strict = "${{ github.event.inputs.strict_version_check }}"

            if ($publish -eq "true" -and "${{ github.event.inputs.version }}" -eq "") {
              Write-Host "âŒ publish=true æ—¶å¿…é¡»æä¾› inputs.version"
              exit 1
            }

            if ("${{ github.event.inputs.version }}" -ne "") {
              $version = "${{ github.event.inputs.version }}"
              Write-Host "ä½¿ç”¨ workflow_dispatch è¾“å…¥ç‰ˆæœ¬: $version"
            } else {
              $content = Get-Content pyproject.toml -Raw
              if ($content -match 'version\s*=\s*"([^"]+)"') {
                $version = $matches[1]
                Write-Host "workflow_dispatch æœªæä¾›ç‰ˆæœ¬ï¼Œä½¿ç”¨ pyproject.toml ç‰ˆæœ¬: $version"
              } else {
                $version = "0.0.0"
                Write-Host "workflow_dispatch æœªæä¾›ç‰ˆæœ¬ä¸”æ— æ³•è¯»å– pyproject.tomlï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $version"
              }
            }
          } elseif ("${{ github.ref_type }}" -eq "tag") {
            $version = "${{ github.ref_name }}".TrimStart("v")
            $targets = "all"
            $publish = "true"
            $strict = "true"
            Write-Host "ä½¿ç”¨ Git æ ‡ç­¾ç‰ˆæœ¬: $version"
          } else {
            $content = Get-Content pyproject.toml -Raw
            if ($content -match 'version\s*=\s*"([^"]+)"') {
              $version = $matches[1]
              Write-Host "ä½¿ç”¨ pyproject.toml ç‰ˆæœ¬: $version"
            } else {
              $version = "0.0.0"
              Write-Host "ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $version"
            }
          }
          
          Write-Host "æœ€ç»ˆç‰ˆæœ¬å·: $version"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TARGETS=$targets" >> $env:GITHUB_OUTPUT
          echo "PUBLISH=$publish" >> $env:GITHUB_OUTPUT
          echo "STRICT=$strict" >> $env:GITHUB_OUTPUT
          echo "PACKAGE_VERSION=v$version" >> $env:GITHUB_ENV

          $tagName = ""
          if ("${{ github.ref_type }}" -eq "tag") {
            $tagName = "${{ github.ref_name }}"
          } elseif ($publish -eq "true") {
            $tagName = "v$version"
          }
          echo "TAG_NAME=$tagName" >> $env:GITHUB_OUTPUT

      - name: "ğŸ§¾ æ ¡éªŒå‘å¸ƒç‰ˆæœ¬ä¸€è‡´æ€§"
        shell: pwsh
        run: |
          $publish = "${{ steps.version.outputs.PUBLISH }}"
          $strict = "${{ steps.version.outputs.STRICT }}"
          $expected = "${{ steps.version.outputs.VERSION }}"

          if ($publish -ne "true") {
            Write-Host "publish=falseï¼Œè·³è¿‡ç‰ˆæœ¬ä¸€è‡´æ€§æ ¡éªŒ"
            exit 0
          }

          $content = Get-Content pyproject.toml -Raw
          if ($content -notmatch 'version\s*=\s*"([^"]+)"') {
            Write-Host "âŒ æ— æ³•ä» pyproject.toml è¯»å–ç‰ˆæœ¬å·"
            exit 1
          }

          $actual = $matches[1]
          # å…è®¸ pre-release åç¼€ï¼štag ä¸º v2.0.1-pre æ—¶ï¼Œä»…æ¯”è¾ƒåŸºç¡€ç‰ˆæœ¬å·
          $expectedBase = ($expected -split '-')[0]
          if ($actual -eq $expected -or $actual -eq $expectedBase) {
            Write-Host "âœ“ ç‰ˆæœ¬ä¸€è‡´: pyproject.toml=$actual, release=$expected"
            exit 0
          }

          $msg = "ç‰ˆæœ¬ä¸ä¸€è‡´: pyproject.toml=$actual, release=$expected"
          if ($strict -eq "true") {
            Write-Host "âŒ $msg"
            exit 1
          } else {
            Write-Host "âš  $msg"
            exit 0
          }

      # ========================================
      # 5. æ„å»º
      # ========================================
      - name: "ğŸ”¨ æ„å»ºæ‰€æœ‰ç›®æ ‡"
        if: github.event_name != 'workflow_dispatch' || github.event.inputs.targets == 'all' || github.event.inputs.targets == ''
        shell: pwsh
        run: python scripts/build.py --target all --version "v${{ steps.version.outputs.VERSION }}"

      - name: "ğŸ”¨ æ„å»º Setup"
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.targets == 'setup'
        shell: pwsh
        run: python scripts/build.py --target setup --version "v${{ steps.version.outputs.VERSION }}"

      - name: "ğŸ”¨ æ„å»º Full"
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.targets == 'full'
        shell: pwsh
        run: python scripts/build.py --target full --version "v${{ steps.version.outputs.VERSION }}"

      - name: "ğŸ”¨ æ„å»º Portable"
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.targets == 'portable'
        shell: pwsh
        run: python scripts/build.py --target portable --version "v${{ steps.version.outputs.VERSION }}"

      - name: "ğŸ” ç”Ÿæˆ SHA256 æ ¡éªŒæ–‡ä»¶"
        shell: pwsh
        run: |
          python -c "from scripts.build import Builder; import os; Builder(version=os.environ.get('PACKAGE_VERSION')).generate_checksums()"

      - name: "âœ… æ ¡éªŒæ„å»ºäº§ç‰©"
        shell: pwsh
        run: |
          $targets = "${{ steps.version.outputs.TARGETS }}"
          $version = "${{ steps.version.outputs.VERSION }}"
          $dir = "release"
          if (-not (Test-Path $dir)) { throw "release ç›®å½•ä¸å­˜åœ¨" }

          function Assert-Exists([string]$pattern) {
            $items = Get-ChildItem -Path $dir -Filter $pattern -ErrorAction SilentlyContinue
            if (-not $items) { throw "ç¼ºå°‘äº§ç‰©: $pattern" }
          }

          if ($targets -eq "all" -or $targets -eq "") {
            Assert-Exists "FluentYTDL-v$version-*-portable.exe"
            Assert-Exists "FluentYTDL-v$version-*-full.7z"
            Assert-Exists "FluentYTDL-v$version-*-setup.exe"
          } elseif ($targets -eq "portable") {
            Assert-Exists "FluentYTDL-v$version-*-portable.exe"
          } elseif ($targets -eq "full") {
            Assert-Exists "FluentYTDL-v$version-*-full.7z"
          } elseif ($targets -eq "setup") {
            Assert-Exists "FluentYTDL-v$version-*-setup.exe"
          } else {
            throw "æœªçŸ¥ targets: $targets"
          }

          Assert-Exists "SHA256SUMS.txt"

      # ========================================
      # 6. åˆ—å‡ºæ„å»ºäº§ç‰©
      # ========================================
      - name: "ğŸ“‹ åˆ—å‡ºæ„å»ºäº§ç‰©"
        shell: pwsh
        run: |
          Write-Host "=== æ„å»ºäº§ç‰© ===" -ForegroundColor Cyan
          Get-ChildItem -Path release -Recurse | ForEach-Object {
            $size = if ($_.PSIsContainer) { "" } else { "{0:N2} MB" -f ($_.Length / 1MB) }
            Write-Host "  $($_.Name) $size"
          }

      # ========================================
      # 7. ä¸Šä¼  Artifacts (ç”¨äºè°ƒè¯•)
      # ========================================
      - name: "ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: FluentYTDL-v${{ steps.version.outputs.VERSION }}-builds
          path: release/*
          retention-days: 30
          if-no-files-found: error

      # ========================================
      # 8. åˆ›å»º GitHub Release
      # ========================================
      - name: "ğŸš€ åˆ›å»º GitHub Release"
        uses: softprops/action-gh-release@v2
        if: success() && (startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish == 'true'))
        with:
          name: FluentYTDL v${{ steps.version.outputs.VERSION }}
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          target_commitish: ${{ github.sha }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
          generate_release_notes: true
          files: |
            release/*.exe
            release/*.7z
            release/SHA256SUMS.txt
          body: |
            ## ğŸ“¦ ä¸‹è½½
            
            | ç‰ˆæœ¬ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
            |------|------|----------|
            | `*-setup.exe` | Windows å®‰è£…åŒ… | æ¨èæ™®é€šç”¨æˆ·ä½¿ç”¨ |
            | `*-full.7z` | ä¾¿æºå®Œæ•´ç‰ˆ | æ— éœ€å®‰è£…ï¼Œè§£å‹å³ç”¨ |
            | `*-portable.exe` | è½»é‡ä¾¿æºç‰ˆ | å•æ–‡ä»¶ï¼Œéœ€è‡ªå¤‡ yt-dlp/ffmpeg |
            
            ## âœ… æ ¡éªŒ
            ä¸‹è½½åè¯·ä½¿ç”¨ `SHA256SUMS.txt` æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§ã€‚
            
            ---
            è‡ªåŠ¨æ„å»ºäº ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
