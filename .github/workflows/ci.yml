# ==============================================================================
#  FluentYTDL - CI æµ‹è¯•å·¥ä½œæµ
# ==============================================================================
# è§¦å‘æ¡ä»¶:
#   - æ¨é€åˆ° main/dev åˆ†æ”¯
#   - Pull Request åˆ° main åˆ†æ”¯
#
# æ‰§è¡Œå†…å®¹:
#   - ä»£ç é£æ ¼æ£€æŸ¥ (ruff)
#   - ç±»å‹æ£€æŸ¥ (pyright)
#   - å•å…ƒæµ‹è¯• (pytest)
# ==============================================================================

name: CI

on:
  push:
    branches:
      - main
      - dev
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  PYTHON_VERSION: '3.12'

jobs:
  lint:
    name: ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install ruff pyright

      - name: ğŸ” Ruff ä»£ç é£æ ¼æ£€æŸ¥
        run: ruff check src/

      - name: ğŸ” Ruff æ ¼å¼æ£€æŸ¥
        run: ruff format --check src/

  typecheck:
    name: ç±»å‹æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install ".[dev]"

      - name: ğŸ” Pyright ç±»å‹æ£€æŸ¥
        run: pyright src/
        continue-on-error: true  # ç±»å‹æ£€æŸ¥è­¦å‘Šä¸é˜»å¡ CI

  test:
    name: å•å…ƒæµ‹è¯•
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: ğŸ è®¾ç½® Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install ".[dev]"

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        run: pytest tests/ -v --tb=short
        continue-on-error: true  # æµ‹è¯•å¤±è´¥ä¸é˜»å¡ï¼ˆå› ä¸ºå¯èƒ½éœ€è¦ GUI ç¯å¢ƒï¼‰

  build-check:
    name: æ„å»ºæ£€æŸ¥ (Windows)
    runs-on: windows-latest
    needs: [lint]
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install ".[dev]"

      - name: ğŸ”¨ éªŒè¯ PyInstaller é…ç½®
        shell: pwsh
        run: |
          # åªéªŒè¯ PyInstaller èƒ½å¤Ÿè§£æä¾èµ–ï¼Œä¸å®é™…æ„å»º
          python -c "
          import PyInstaller.__main__
          from pathlib import Path
          print('PyInstaller å¯ç”¨')
          
          # æ£€æŸ¥å…¥å£ç‚¹
          main_py = Path('main.py')
          if main_py.exists():
              print(f'å…¥å£ç‚¹å­˜åœ¨: {main_py}')
          else:
              raise FileNotFoundError('main.py ä¸å­˜åœ¨')
          
          # æ£€æŸ¥ src ç›®å½•
          src_dir = Path('src/fluentytdl')
          if src_dir.exists():
              print(f'æºç ç›®å½•å­˜åœ¨: {src_dir}')
          else:
              raise FileNotFoundError('src/fluentytdl ä¸å­˜åœ¨')
          
          print('âœ“ æ„å»ºé…ç½®æ£€æŸ¥é€šè¿‡')
          "
