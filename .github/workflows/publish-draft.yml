name: Publish Draft Release

on:
  push:
    tags:
      - 'v*'

jobs:
  publish-draft:
    runs-on: ubuntu-latest
    steps:
      - name: Debug info
        run: |
          echo "Ref: $GITHUB_REF"
          echo "Tag: ${GITHUB_REF#refs/tags/}"

      - name: Fetch release by tag
        id: get_release
        env:
          TOKEN: ${{ secrets.TEST_UPLOAD_PAT }}
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Looking up release for tag: $TAG"
          RELEASE_JSON=$(curl -s -H "Authorization: token $TOKEN" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/$TAG")
          echo "$RELEASE_JSON" > release.json
          echo "RELEASE_JSON:"; cat release.json
          ID=$(python - <<PY
import sys,json
try:
  j=json.load(sys.stdin)
  print(j.get('id',''))
except Exception as e:
  print('')
PY
 < release.json)
          if [ -z "$ID" ]; then echo "No release found for tag $TAG or cannot access it"; exit 1; fi
          echo "release_id=$ID" >> $GITHUB_OUTPUT

      - name: Publish release (unset draft)
        env:
          TOKEN: ${{ secrets.TEST_UPLOAD_PAT }}
        run: |
          ID=${{ steps.get_release.outputs.release_id }}
          TAG=${GITHUB_REF#refs/tags/}
          BODY="Published by CI for tag $TAG"
          echo "Patching release id: $ID"
          RESP=$(curl -s -X PATCH -H "Authorization: token $TOKEN" -H "Content-Type: application/json" -d "{\"draft\":false, \"body\": \"$BODY\"}" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/$ID")
          echo "$RESP" > patched.json
          echo "Patched release:"; cat patched.json
          # Fail if published is not true
          PUBLISHED=$(python - <<PY
import sys,json
try:
  j=json.load(sys.stdin)
  print(j.get('draft'))
except:
  print('error')
PY
 < patched.json)
          if [ "$PUBLISHED" = "False" ] || [ "$PUBLISHED" = "true" ]; then
              echo "Publish response: $PUBLISHED"
          else
              echo "Unexpected publish response: $PUBLISHED"; exit 1
          fi
