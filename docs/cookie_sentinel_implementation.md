# FluentYTDL Cookie å«å£« (Cookie Sentinel) - æŠ€æœ¯å®ç°æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

**Cookie å«å£«**æ˜¯ä¸º FluentYTDL è®¾è®¡çš„æ™ºèƒ½ Cookie ç”Ÿå‘½å‘¨æœŸç®¡ç†ç³»ç»Ÿï¼Œè§£å†³äº† YouTube ä¸‹è½½ä¸­çš„ Cookie å¤±æ•ˆé—®é¢˜ï¼Œæä¾›æ— ç¼çš„ç”¨æˆ·ä½“éªŒã€‚

### ğŸ¯ æ ¸å¿ƒç›®æ ‡

1. **å¯åŠ¨æ—¶é™é»˜é¢„æå–** - åº”ç”¨å¯åŠ¨æ—¶åå°è‡ªåŠ¨æ›´æ–° Cookieï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„
2. **ç»Ÿä¸€æ–‡ä»¶ç®¡ç†** - æ‰€æœ‰ Cookie ç»Ÿä¸€å­˜å‚¨åœ¨ `bin/cookies.txt`ï¼Œyt-dlp å§‹ç»ˆè¯»å–è¯¥æ–‡ä»¶
3. **æ™ºèƒ½é”™è¯¯æ£€æµ‹** - è‡ªåŠ¨è¯†åˆ« 403/ç™»å½•è¦æ±‚ç­‰ Cookie ç›¸å…³é”™è¯¯
4. **ä¼˜é›…çš„ä¿®å¤æµç¨‹** - é”™è¯¯å‘ç”Ÿæ—¶å¼¹çª—å¼•å¯¼ç”¨æˆ·ï¼Œæ”¯æŒä¸€é”®ä¿®å¤

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç»„ä»¶å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å¯åŠ¨ (main.py)                        â”‚
â”‚  åå°çº¿ç¨‹ï¼šcookie_sentinel.silent_refresh_on_startup()       â”‚
â”‚  - å»¶è¿Ÿ 2 ç§’å¯åŠ¨ï¼Œä¸é˜»å¡ UI                                   â”‚
â”‚  - é™é»˜å°è¯•ä»æµè§ˆå™¨æå– Cookie                                â”‚
â”‚  - å¤±è´¥ä¸æŠ¥é”™ï¼Œä¿ç•™æ—§æ–‡ä»¶                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CookieSentinel (cookie_sentinel.py)            â”‚
â”‚  å•ä¾‹æ¨¡å¼ï¼Œç»Ÿä¸€ç®¡ç† bin/cookies.txt                          â”‚
â”‚                                                              â”‚
â”‚  æ ¸å¿ƒæ–¹æ³•ï¼š                                                   â”‚
â”‚  â€¢ get_cookie_file_path() - è¿”å›ç»Ÿä¸€è·¯å¾„ç»™ yt-dlp           â”‚
â”‚  â€¢ silent_refresh_on_startup() - å¯åŠ¨æ—¶é™é»˜æ›´æ–°             â”‚
â”‚  â€¢ force_refresh_with_uac() - ç”¨æˆ·è§¦å‘ï¼Œå…è®¸ UAC           â”‚
â”‚  â€¢ detect_cookie_error(stderr) - é”™è¯¯ç‰¹å¾æ£€æµ‹               â”‚
â”‚                                                              â”‚
â”‚  ä¾èµ–ï¼š                                                       â”‚
â”‚  â€¢ auth_service (æµè§ˆå™¨æå– + UAC ææƒ)                     â”‚
â”‚  â€¢ rookiepy (è·¨æµè§ˆå™¨ Cookie è¯»å–)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           YoutubeService (youtube_service.py)               â”‚
â”‚  yt-dlp è°ƒç”¨å°è£…ï¼ŒCookie è·¯å¾„æ³¨å…¥                            â”‚
â”‚                                                              â”‚
â”‚  ä¿®æ”¹ç‚¹ï¼š                                                     â”‚
â”‚  â€¢ ä¼˜å…ˆä½¿ç”¨ cookie_sentinel.get_cookie_file_path()         â”‚
â”‚  â€¢ æ˜¾ç¤º Cookie çŠ¶æ€ï¼ˆæ›´æ–°æ—¶é—´ã€æ¥æºï¼‰                        â”‚
â”‚  â€¢ --cookies "bin/cookies.txt" ä¼ é€’ç»™ yt-dlp               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            DownloadWorker (workers.py)                      â”‚
â”‚  æ‰§è¡Œä¸‹è½½ï¼Œç›‘æ§ stderr è¾“å‡º                                   â”‚
â”‚                                                              â”‚
â”‚  æ–°å¢ä¿¡å·ï¼š                                                   â”‚
â”‚  â€¢ cookie_error_detected(str) - Cookie é”™è¯¯è§¦å‘             â”‚
â”‚                                                              â”‚
â”‚  é”™è¯¯æ£€æµ‹é€»è¾‘ï¼š                                               â”‚
â”‚  â€¢ æ•è· yt-dlp é€€å‡ºç  != 0                                   â”‚
â”‚  â€¢ è°ƒç”¨ cookie_sentinel.detect_cookie_error(stderr)        â”‚
â”‚  â€¢ åŒ¹é…å…³é”®å­—ï¼š403/Sign in/Age confirm/Private video       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          DownloadCard (download_card.py)                    â”‚
â”‚  ä¸‹è½½ä»»åŠ¡ UI å¡ç‰‡                                             â”‚
â”‚                                                              â”‚
â”‚  è¿æ¥ä¿¡å·ï¼š                                                   â”‚
â”‚  â€¢ worker.cookie_error_detected â†’ _on_cookie_error()       â”‚
â”‚                                                              â”‚
â”‚  ä¿®å¤æµç¨‹ï¼š                                                   â”‚
â”‚  1. å¼¹å‡º CookieRepairDialog å¯¹è¯æ¡†                           â”‚
â”‚  2. ç”¨æˆ·é€‰æ‹©"è‡ªåŠ¨ä¿®å¤"æˆ–"æ‰‹åŠ¨å¯¼å…¥"                            â”‚
â”‚  3. è‡ªåŠ¨ä¿®å¤ï¼šè°ƒç”¨ cookie_sentinel.force_refresh_with_uac() â”‚
â”‚  4. ä¿®å¤æˆåŠŸåè‡ªåŠ¨é‡è¯•ä¸‹è½½                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CookieRepairDialog (cookie_repair_dialog.py)            â”‚
â”‚  ç”¨æˆ·å‹å¥½çš„ä¿®å¤å¼•å¯¼ç•Œé¢                                       â”‚
â”‚                                                              â”‚
â”‚  æä¾›é€‰é¡¹ï¼š                                                   â”‚
â”‚  â€¢ ğŸ”§ è‡ªåŠ¨ä¿®å¤ - è§¦å‘ UAC ææƒé‡æ–°æå–                       â”‚
â”‚  â€¢ ğŸ“ æ‰‹åŠ¨å¯¼å…¥ - è·³è½¬åˆ°è®¾ç½®é¡µé¢                              â”‚
â”‚  â€¢ â­ï¸ ç¨åå¤„ç† - å…³é—­å¯¹è¯æ¡†                                  â”‚
â”‚                                                              â”‚
â”‚  æ˜¾ç¤ºå†…å®¹ï¼š                                                   â”‚
â”‚  â€¢ å‹å¥½çš„é”™è¯¯è¯´æ˜                                             â”‚
â”‚  â€¢ æˆªæ–­çš„é”™è¯¯è¯¦æƒ…ï¼ˆé¿å…è¿‡é•¿ï¼‰                                 â”‚
â”‚  â€¢ å®æ—¶ä¿®å¤ç»“æœåé¦ˆ                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. CookieSentinel ç±»ï¼ˆcookie_sentinel.pyï¼‰

**èŒè´£**ï¼šç»Ÿä¸€ç®¡ç† `bin/cookies.txt` çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

#### å…³é”®å±æ€§

```python
self.cookie_path: Path           # ç»Ÿä¸€çš„ Cookie æ–‡ä»¶è·¯å¾„
self._last_update: datetime      # æœ€åæ›´æ–°æ—¶é—´
self._is_updating: bool          # æ›´æ–°é”ï¼ˆé˜²æ­¢å¹¶å‘ï¼‰
```

#### å…³é”®æ–¹æ³•

##### `silent_refresh_on_startup()`
- å¯åŠ¨æ—¶åœ¨åå°çº¿ç¨‹è°ƒç”¨
- æ£€æŸ¥ `auth_service.current_source`ï¼ˆç”¨æˆ·åœ¨è®¾ç½®ä¸­é€‰æ‹©çš„æµè§ˆå™¨ï¼‰
- å°è¯•æå– Cookieï¼ˆ**ä¸è¯·æ±‚ UAC**ï¼‰
- å¤±è´¥æ—¶é™é»˜æ•è·å¼‚å¸¸ï¼Œä¸å½±å“åº”ç”¨å¯åŠ¨

```python
def silent_refresh_on_startup(self) -> None:
    def _refresh_worker():
        try:
            if current_source == AuthSourceType.FILE:
                self._copy_from_auth_service()
            else:
                self._update_from_browser(silent=True)
        except Exception:
            # é™é»˜å¤±è´¥ï¼Œä¿ç•™æ—§æ–‡ä»¶
            logger.debug("é™é»˜åˆ·æ–°å¤±è´¥ï¼ˆé¢„æœŸè¡Œä¸ºï¼‰")
    
    threading.Thread(target=_refresh_worker, daemon=True).start()
```

##### `force_refresh_with_uac()`
- ç”¨æˆ·ä¸»åŠ¨è§¦å‘ï¼ˆç‚¹å‡»ä¿®å¤æŒ‰é’®ï¼‰
- **å…è®¸ UAC ææƒ**ï¼ˆå¤„ç† Chrome v130+ App-Bound åŠ å¯†ï¼‰
- è¿”å› `(success: bool, message: str)`

```python
def force_refresh_with_uac(self) -> tuple[bool, str]:
    auth_cookie_file = auth_service.get_cookie_file_for_ytdlp(
        platform="youtube",
        force_refresh=True  # è§¦å‘ UAC
    )
    
    if auth_cookie_file:
        shutil.copy2(auth_cookie_file, self.cookie_path)
        return True, "âœ… Cookie å·²æ›´æ–°"
    else:
        return False, auth_service.last_status.message
```

##### `detect_cookie_error(ytdlp_stderr: str)`
- è§£æ yt-dlp çš„ stderr è¾“å‡º
- åŒ¹é… Cookie ç›¸å…³é”™è¯¯ç‰¹å¾
- è¿”å›å¸ƒå°”å€¼

```python
cookie_keywords = [
    "sign in to confirm your age",
    "http error 403",
    "private video",
    "members-only",
    "requires authentication",
]

return any(keyword in stderr.lower() for keyword in cookie_keywords)
```

---

### 2. YoutubeService é›†æˆï¼ˆyoutube_service.pyï¼‰

**ä¿®æ”¹ç‚¹**ï¼šå°† Cookie æ¥æºä» AuthService åˆ‡æ¢åˆ° CookieSentinel

#### åŸé€»è¾‘ï¼ˆå·²åºŸå¼ƒï¼‰
```python
# æ—§ï¼šæ¯æ¬¡è°ƒç”¨ yt-dlp éƒ½ä» AuthService æå–ï¼ˆå¯èƒ½è§¦å‘ UACï¼‰
auth_cookie_file = auth_service.get_cookie_file_for_ytdlp()
ydl_opts["cookiefile"] = auth_cookie_file
```

#### æ–°é€»è¾‘
```python
# æ–°ï¼šç»Ÿä¸€ä½¿ç”¨ bin/cookies.txt
from ..core.cookie_sentinel import cookie_sentinel

cookiefile = cookie_sentinel.get_cookie_file_path()  # å›ºå®šè·¯å¾„

if cookie_sentinel.exists:
    ydl_opts["cookiefile"] = cookiefile
    
    # æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
    age = cookie_sentinel.age_minutes
    status_emoji = "âš ï¸" if cookie_sentinel.is_stale else "âœ…"
    self._emit_log("info", f"{status_emoji} Cookie: {age}åˆ†é’Ÿå‰æ›´æ–°")
```

**ä¼˜åŠ¿**ï¼š
- yt-dlp å¯åŠ¨æå¿«ï¼ˆæ— éœ€è¿è¡Œæ—¶æµè§ˆå™¨è®¿é—®ï¼‰
- Cookie è·¯å¾„å›ºå®šï¼Œä¾¿äºè°ƒè¯•
- çŠ¶æ€é€æ˜ï¼ˆç”¨æˆ·å¯è§æ›´æ–°æ—¶é—´ï¼‰

---

### 3. DownloadWorker é”™è¯¯æ£€æµ‹ï¼ˆworkers.pyï¼‰

**æ–°å¢**ï¼š`cookie_error_detected` ä¿¡å·

#### å®ç°ä½ç½®

åœ¨ `_download_via_exe()` æ–¹æ³•ä¸­ï¼Œyt-dlp è¿›ç¨‹é€€å‡ºåï¼š

```python
rc = self._proc.wait(timeout=2)

if rc and rc != 0:
    error_text = "\n".join(tail)  # æœ€å 120 è¡Œè¾“å‡º
    
    # Cookie é”™è¯¯æ£€æµ‹
    from ..core.cookie_sentinel import cookie_sentinel
    if cookie_sentinel.detect_cookie_error(error_text):
        self.cookie_error_detected.emit(error_text)  # è§¦å‘ä¿®å¤æµç¨‹
        logger.warning("[CookieSentinel] æ£€æµ‹åˆ° Cookie ç›¸å…³é”™è¯¯")
    
    raise RuntimeError("yt-dlp.exe é€€å‡ºå¼‚å¸¸:\n" + error_text)
```

**å…³é”®è®¾è®¡**ï¼š
- é”™è¯¯æ£€æµ‹**åœ¨æŠ›å‡ºå¼‚å¸¸ä¹‹å‰**æ‰§è¡Œ
- ä¿¡å·å‘é€åï¼ŒUI å¯åœ¨å¼‚å¸¸å¤„ç†å‰æ‹¦æˆª
- ä½¿ç”¨ `tail` å˜é‡ï¼ˆæœ€å 120 è¡Œï¼‰é¿å…è¯¯åˆ¤

---

### 4. UI ä¿®å¤æµç¨‹ï¼ˆdownload_card.pyï¼‰

#### ä¿¡å·è¿æ¥

```python
def _bind_worker(self, worker: DownloadWorker) -> None:
    # ... å…¶ä»–ä¿¡å· ...
    worker.cookie_error_detected.connect(self._on_cookie_error)
```

#### ä¿®å¤é€»è¾‘

```python
def _on_cookie_error(self, error_message: str) -> None:
    from .cookie_repair_dialog import CookieRepairDialog
    from ...core.cookie_sentinel import cookie_sentinel
    
    dialog = CookieRepairDialog(error_message, parent=self.window())
    
    # è‡ªåŠ¨ä¿®å¤å›è°ƒ
    def on_auto_repair():
        success, message = cookie_sentinel.force_refresh_with_uac()
        dialog.show_repair_result(success, message)
        
        if success:
            # ä¿®å¤æˆåŠŸï¼Œ2 ç§’åè‡ªåŠ¨é‡è¯•ä¸‹è½½
            QTimer.singleShot(2000, self._retry_download)
    
    dialog.repair_requested.connect(on_auto_repair)
    dialog.exec()
```

**ç”¨æˆ·ä½“éªŒæµç¨‹**ï¼š

1. ä¸‹è½½å¤±è´¥ â†’ æ£€æµ‹åˆ° Cookie é”™è¯¯
2. å¼¹å‡ºä¿®å¤å¯¹è¯æ¡†ï¼ˆæš‚åœä¸‹è½½ä»»åŠ¡ï¼‰
3. ç”¨æˆ·ç‚¹å‡»"è‡ªåŠ¨ä¿®å¤" â†’ è§¦å‘ UACï¼ˆå¦‚éœ€è¦ï¼‰
4. ä¿®å¤æˆåŠŸæ˜¾ç¤ºç»¿è‰²æç¤ºæ¡
5. 2 ç§’åè‡ªåŠ¨é‡è¯•ä¸‹è½½
6. å¯¹è¯æ¡†è‡ªåŠ¨å…³é—­

---

### 5. CookieRepairDialog å¯¹è¯æ¡†ï¼ˆcookie_repair_dialog.pyï¼‰

#### UI ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”’ æ£€æµ‹åˆ° Cookie éªŒè¯å¤±è´¥                   â”‚
â”‚                                              â”‚
â”‚  YouTube éœ€è¦é‡æ–°éªŒè¯èº«ä»½ï¼Œè¯·é€‰æ‹©ï¼š          â”‚
â”‚  â€¢ è‡ªåŠ¨ä¿®å¤ï¼šä»æµè§ˆå™¨é‡æ–°æå–ï¼ˆå¯èƒ½éœ€è¦UACï¼‰ â”‚
â”‚  â€¢ æ‰‹åŠ¨å¯¼å…¥ï¼šä½¿ç”¨æµè§ˆå™¨æ‰©å±•å¯¼å‡º cookies.txt  â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ é”™è¯¯è¯¦æƒ…ï¼š                           â”‚    â”‚
â”‚  â”‚ ERROR: Sign in to confirm your age  â”‚    â”‚
â”‚  â”‚ ... (è¿˜æœ‰ 3 è¡Œ)                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                              â”‚
â”‚  [ ç¨åå¤„ç† ]    [ æ‰‹åŠ¨å¯¼å…¥ ]  [ è‡ªåŠ¨ä¿®å¤ ] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…³é”®ç‰¹æ€§

- **æ¨¡æ€å¯¹è¯æ¡†**ï¼ˆé˜»æ­¢åå°æ“ä½œï¼Œç¡®ä¿ç”¨æˆ·æ³¨æ„ï¼‰
- **é”™è¯¯è¯¦æƒ…æˆªæ–­**ï¼ˆæœ€å¤šæ˜¾ç¤º 5 è¡Œï¼Œé¿å…è¿‡é•¿ï¼‰
- **ä¿®å¤ç»“æœåé¦ˆ**ï¼ˆInfoBar æ˜¾ç¤ºæˆåŠŸ/å¤±è´¥æ¶ˆæ¯ï¼‰
- **è‡ªåŠ¨å…³é—­**ï¼ˆä¿®å¤æˆåŠŸå 1.5 ç§’è‡ªåŠ¨å…³é—­ï¼‰

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### åœºæ™¯ 1ï¼šæ­£å¸¸å¯åŠ¨

```
1. ç”¨æˆ·å¯åŠ¨åº”ç”¨
   â†“
2. main.py åˆ›å»º cookie_sentinel å®ä¾‹
   â†“
3. åå°çº¿ç¨‹å»¶è¿Ÿ 2 ç§’å¯åŠ¨
   â†“
4. é™é»˜è°ƒç”¨ silent_refresh_on_startup()
   â†“
5. æ£€æŸ¥ auth_service.current_sourceï¼ˆç”¨æˆ·é€‰æ‹©çš„æµè§ˆå™¨ï¼‰
   â†“
6. å°è¯•æå– Cookie åˆ° bin/cookies.txt
   â†“
7. æˆåŠŸ â†’ æ–‡ä»¶å·²æ›´æ–°ï¼Œæ—¥å¿—è®°å½•
   å¤±è´¥ â†’ é™é»˜æ•è·ï¼Œä¿ç•™æ—§æ–‡ä»¶
   â†“
8. åº”ç”¨ç»§ç»­æ­£å¸¸è¿è¡Œï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥ï¼‰
```

### åœºæ™¯ 2ï¼šä¸‹è½½æ—¶ Cookie å¤±æ•ˆ

```
1. ç”¨æˆ·ç‚¹å‡»ä¸‹è½½æŒ‰é’®
   â†“
2. YoutubeService è°ƒç”¨ yt-dlp
   å‚æ•°ï¼š--cookies "bin/cookies.txt"
   â†“
3. yt-dlp è¿”å› 403 Forbidden
   stderr: "Sign in to confirm your age"
   â†“
4. DownloadWorker æ•è·é€€å‡ºç  != 0
   â†“
5. cookie_sentinel.detect_cookie_error(stderr) â†’ True
   â†“
6. å‘é€ cookie_error_detected ä¿¡å·
   â†“
7. DownloadCard._on_cookie_error() è§¦å‘
   â†“
8. å¼¹å‡º CookieRepairDialog å¯¹è¯æ¡†
   â†“
9. ç”¨æˆ·ç‚¹å‡»"è‡ªåŠ¨ä¿®å¤"
   â†“
10. cookie_sentinel.force_refresh_with_uac()
    â€¢ è°ƒç”¨ auth_serviceï¼ˆå…è®¸ UACï¼‰
    â€¢ rookiepy æå–æµè§ˆå™¨ Cookie
    â€¢ è¦†ç›– bin/cookies.txt
   â†“
11. ä¿®å¤æˆåŠŸ â†’ æ˜¾ç¤ºç»¿è‰²æç¤ºæ¡
   â†“
12. 2 ç§’åè‡ªåŠ¨é‡è¯•ä¸‹è½½
   â†“
13. ä¸‹è½½æˆåŠŸå®Œæˆ
```

### åœºæ™¯ 3ï¼šChrome v130+ App-Bound åŠ å¯†

```
1. é™é»˜åˆ·æ–°å°è¯•æå– Chrome Cookie
   â†“
2. rookiepy æŠ›å‡º "requires admin" å¼‚å¸¸
   â†“
3. é™é»˜æ¨¡å¼æ•è·å¼‚å¸¸ï¼Œä¸å¼¹çª—
   â†“
4. ä¿ç•™æ—§çš„ bin/cookies.txtï¼ˆå¦‚æœå­˜åœ¨ï¼‰
   â†“
5. ç”¨æˆ·ä¸‹è½½æ—¶å¤±è´¥ â†’ å¼¹å‡ºä¿®å¤å¯¹è¯æ¡†
   â†“
6. ç”¨æˆ·ç‚¹å‡»"è‡ªåŠ¨ä¿®å¤" â†’ è§¦å‘ UAC
   â†“
7. elevated_extractor.py ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œ
   â†“
8. æˆåŠŸæå–å¹¶æ›´æ–° bin/cookies.txt
   â†“
9. è‡ªåŠ¨é‡è¯•ä¸‹è½½æˆåŠŸ
```

---

## ğŸ“Š å…³é”®å†³ç­–ä¸æƒè¡¡

### å†³ç­– 1ï¼šå¯åŠ¨æ—¶é™é»˜ vs æ¯æ¬¡ä¸‹è½½æ—¶æå–

**é€‰æ‹©**ï¼šå¯åŠ¨æ—¶é™é»˜é¢„æå–

**åŸå› **ï¼š
- âœ… yt-dlp å¯åŠ¨æå¿«ï¼ˆæ— éœ€è¿è¡Œæ—¶æµè§ˆå™¨è®¿é—®ï¼‰
- âœ… å‡å°‘ UAC å¼¹çª—é¢‘ç‡ï¼ˆåªåœ¨éœ€è¦æ—¶è§¦å‘ï¼‰
- âœ… ç”¨æˆ·ä½“éªŒæµç•…ï¼ˆä¸‹è½½ç«‹å³å¼€å§‹ï¼‰
- âŒ å¯èƒ½å­˜åœ¨ Cookie è¿‡æœŸï¼ˆé€šè¿‡é”™è¯¯æ£€æµ‹ + ä¿®å¤å¼¥è¡¥ï¼‰

**ç¼“è§£æªæ–½**ï¼š
- Cookie æœ‰æ•ˆæœŸé€šå¸¸ > 1 å°æ—¶
- æ£€æµ‹åˆ°é”™è¯¯æ—¶ç«‹å³è§¦å‘ä¿®å¤
- æ”¯æŒæ‰‹åŠ¨åˆ·æ–°ï¼ˆè®¾ç½®é¡µé¢ï¼‰

### å†³ç­– 2ï¼šç»Ÿä¸€æ–‡ä»¶ vs å¤šæ–‡ä»¶ç¼“å­˜

**é€‰æ‹©**ï¼šç»Ÿä¸€ `bin/cookies.txt`

**åŸå› **ï¼š
- âœ… ç®€å•å¯é ï¼ˆå•ä¸€çœŸç›¸æ¥æºï¼‰
- âœ… ä¾¿äºè°ƒè¯•ï¼ˆç”¨æˆ·å¯æ‰‹åŠ¨æ£€æŸ¥æ–‡ä»¶ï¼‰
- âœ… é¿å…ç¼“å­˜åŒæ­¥é—®é¢˜
- âŒ ä¸æ”¯æŒå¤šè´¦æˆ·ï¼ˆåç»­å¯æ‰©å±•ï¼‰

**æ‰©å±•æ–¹æ¡ˆ**ï¼š
- å¯åœ¨è®¾ç½®ä¸­æ·»åŠ "åˆ‡æ¢è´¦æˆ·"åŠŸèƒ½
- å°† `bin/cookies.txt` ä½œä¸º"å½“å‰è´¦æˆ·"çš„ç¬¦å·é“¾æ¥

### å†³ç­– 3ï¼šè‡ªåŠ¨é‡è¯• vs ç”¨æˆ·æ‰‹åŠ¨é‡è¯•

**é€‰æ‹©**ï¼šä¿®å¤æˆåŠŸåè‡ªåŠ¨é‡è¯•

**åŸå› **ï¼š
- âœ… ç”¨æˆ·ä½“éªŒè¿è´¯ï¼ˆä¿®å¤ â†’ é‡è¯•ä¸€æ°”å‘µæˆï¼‰
- âœ… å‡å°‘æ“ä½œæ­¥éª¤
- âŒ å¯èƒ½æµªè´¹å¸¦å®½ï¼ˆå¦‚æœç”¨æˆ·ä¸æƒ³ç»§ç»­ï¼‰

**ç¼“è§£æªæ–½**ï¼š
- å»¶è¿Ÿ 2 ç§’é‡è¯•ï¼ˆç»™ç”¨æˆ·å–æ¶ˆæœºä¼šï¼‰
- æ˜¾ç¤ºæ˜ç¡®çš„çŠ¶æ€æ¶ˆæ¯

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æ‰‹åŠ¨æµ‹è¯•æ¸…å•

#### 1. å¯åŠ¨æ—¶é™é»˜åˆ·æ–°
- [ ] æœªé…ç½®éªŒè¯æº â†’ ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
- [ ] é…ç½® Edge æµè§ˆå™¨ â†’ æˆåŠŸæå–åˆ° bin/cookies.txt
- [ ] é…ç½® Chromeï¼ˆæ— ç®¡ç†å‘˜æƒé™ï¼‰â†’ é™é»˜å¤±è´¥ï¼Œä¸å¼¹çª—
- [ ] æ£€æŸ¥æ—¥å¿—ï¼šåº”æœ‰ "é™é»˜åˆ·æ–°" ç›¸å…³æ¡ç›®

#### 2. ä¸‹è½½æ­£å¸¸æµç¨‹
- [ ] bin/cookies.txt å­˜åœ¨ä¸”æœ‰æ•ˆ â†’ ä¸‹è½½æˆåŠŸ
- [ ] æ£€æŸ¥ yt-dlp æ—¥å¿—ï¼šåº”æœ‰ `--cookies "bin/cookies.txt"`

#### 3. Cookie å¤±æ•ˆæ£€æµ‹
- [ ] æ‰‹åŠ¨åˆ é™¤ bin/cookies.txt â†’ ä¸‹è½½å¤±è´¥ï¼ˆ403ï¼‰
- [ ] åº”å¼¹å‡º CookieRepairDialog å¯¹è¯æ¡†
- [ ] é”™è¯¯è¯¦æƒ…æ˜¾ç¤ºæˆªæ–­åçš„ stderr

#### 4. è‡ªåŠ¨ä¿®å¤æµç¨‹
- [ ] ç‚¹å‡»"è‡ªåŠ¨ä¿®å¤" â†’ è§¦å‘ UACï¼ˆChrome v130+ï¼‰
- [ ] UAC é€šè¿‡ â†’ æ˜¾ç¤ºç»¿è‰²æˆåŠŸæç¤º
- [ ] 2 ç§’åè‡ªåŠ¨é‡è¯•ä¸‹è½½
- [ ] ä¸‹è½½æˆåŠŸå®Œæˆ

#### 5. æ‰‹åŠ¨å¯¼å…¥æµç¨‹
- [ ] ç‚¹å‡»"æ‰‹åŠ¨å¯¼å…¥" â†’ å¯¹è¯æ¡†å…³é—­
- [ ] è·³è½¬åˆ°è®¾ç½®é¡µé¢ï¼ˆå¦‚æœ‰ï¼‰

#### 6. è¾¹ç¼˜æƒ…å†µ
- [ ] ä¿®å¤æœŸé—´å…³é—­å¯¹è¯æ¡† â†’ ä¸é‡è¯•ä¸‹è½½
- [ ] UAC æ‹’ç» â†’ æ˜¾ç¤ºçº¢è‰²å¤±è´¥æç¤ºï¼ŒæŒ‰é’®æ¢å¤
- [ ] rookiepy æœªå®‰è£… â†’ æ˜¾ç¤ºæ˜ç¡®é”™è¯¯æ¶ˆæ¯

---

## ğŸ”§ é…ç½®ä¸ç»´æŠ¤

### ç”¨æˆ·é…ç½®é¡¹ï¼ˆsettings é¡µé¢ï¼‰

```python
# éªŒè¯æºè®¾ç½®
auth_service.set_source(
    source=AuthSourceType.EDGE,  # æµè§ˆå™¨é€‰æ‹©
    auto_refresh=True,            # å¯åŠ¨æ—¶è‡ªåŠ¨åˆ·æ–°
)

# æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®
auth_service.refresh_now()
```

### æ—¥å¿—ç›‘æ§

å…³é”®æ—¥å¿—å‰ç¼€ï¼š`[CookieSentinel]`

```
[CookieSentinel] å¯åŠ¨æ—¶é™é»˜åˆ·æ–°å¼€å§‹...
[CookieSentinel] Cookie å·²æ›´æ–°: D:/YouTube/FluentYTDL/bin/cookies.txt
[CookieSentinel] æ£€æµ‹åˆ° Cookie ç›¸å…³é”™è¯¯
[CookieSentinel] ç”¨æˆ·è§¦å‘å¼ºåˆ¶åˆ·æ–°ï¼ˆå…è®¸ UACï¼‰
```

### æ•…éšœæ’æŸ¥

#### é—®é¢˜ï¼šå¯åŠ¨æ—¶æœªè‡ªåŠ¨åˆ·æ–°
- æ£€æŸ¥ `auth_service.current_source` æ˜¯å¦ä¸º `NONE`
- æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰ "é™é»˜åˆ·æ–°å¤±è´¥" æ¡ç›®
- ç¡®è®¤ rookiepy å·²å®‰è£…ï¼š`pip show rookiepy`

#### é—®é¢˜ï¼šä¿®å¤å¯¹è¯æ¡†æœªå¼¹å‡º
- æ£€æŸ¥ `detect_cookie_error()` è¿”å›å€¼
- ç¡®è®¤ `cookie_error_detected` ä¿¡å·å·²è¿æ¥
- æŸ¥çœ‹ yt-dlp stderr è¾“å‡ºæ˜¯å¦åŒ…å«å…³é”®å­—

#### é—®é¢˜ï¼šUAC ææƒå¤±è´¥
- ç¡®è®¤ `elevated_extractor.py` å­˜åœ¨äºé¡¹ç›®ä¸­
- æ£€æŸ¥ `ELEVATED_COOKIE_PATH` ä¸´æ—¶æ–‡ä»¶
- æŸ¥çœ‹ `ELEVATED_LOG_PATH` é”™è¯¯æ—¥å¿—

---

## ğŸ“š ä¾èµ–æ¨¡å—

### æ ¸å¿ƒä¾èµ–

- **rookiepy** - è·¨æµè§ˆå™¨ Cookie æå–åº“
  ```bash
  pip install rookiepy
  ```

- **PySide6** - Qt GUI æ¡†æ¶
- **qfluentwidgets** - Fluent Design ç»„ä»¶åº“

### å†…éƒ¨æ¨¡å—

- `auth_service.py` - æµè§ˆå™¨ Cookie æå– + UAC ææƒ
- `elevated_extractor.py` - ç®¡ç†å‘˜æƒé™æå–è„šæœ¬
- `youtube_service.py` - yt-dlp è°ƒç”¨å°è£…
- `translator.py` - é”™è¯¯æ¶ˆæ¯ç¿»è¯‘

---

## ğŸš€ æœªæ¥æ‰©å±•

### é˜¶æ®µ 2ï¼šå¤šè´¦æˆ·æ”¯æŒ

```python
# è´¦æˆ·é…ç½®æ–‡ä»¶
accounts = {
    "YouTube Premium": "bin/cookies_premium.txt",
    "YouTube Free": "bin/cookies_free.txt",
}

# åˆ‡æ¢è´¦æˆ·
cookie_sentinel.switch_account("YouTube Premium")
```

### é˜¶æ®µ 3ï¼šCookie å¥åº·æ£€æŸ¥

```python
# å®šæœŸéªŒè¯ Cookie æœ‰æ•ˆæ€§ï¼ˆæ— éœ€å®é™…ä¸‹è½½ï¼‰
health = cookie_sentinel.check_health()
# {
#   "valid": True,
#   "age_hours": 2.5,
#   "expiry_days": 30,
#   "recommended_action": "none"
# }
```

### é˜¶æ®µ 4ï¼šæ™ºèƒ½åˆ·æ–°ç­–ç•¥

```python
# æ ¹æ®ä½¿ç”¨é¢‘ç‡è°ƒæ•´åˆ·æ–°ç­–ç•¥
if frequent_downloads and age > 1_hour:
    cookie_sentinel.auto_refresh()
```

---

## ğŸ“„ ä»£ç æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

1. `src/fluentytdl/core/cookie_sentinel.py` (320 è¡Œ)
   - CookieSentinel æ ¸å¿ƒç±»

2. `src/fluentytdl/ui/components/cookie_repair_dialog.py` (170 è¡Œ)
   - ä¿®å¤å¯¹è¯æ¡† UI

### ä¿®æ”¹æ–‡ä»¶

1. `main.py`
   - æ·»åŠ å¯åŠ¨æ—¶é™é»˜åˆ·æ–°çº¿ç¨‹

2. `src/fluentytdl/youtube/youtube_service.py`
   - Cookie è·¯å¾„åˆ‡æ¢åˆ° CookieSentinel
   - æ˜¾ç¤º Cookie çŠ¶æ€ä¿¡æ¯

3. `src/fluentytdl/download/workers.py`
   - æ·»åŠ  `cookie_error_detected` ä¿¡å·
   - é”™è¯¯æ£€æµ‹é€»è¾‘

4. `src/fluentytdl/ui/components/download_card.py`
   - è¿æ¥ Cookie é”™è¯¯ä¿¡å·
   - å®ç°ä¿®å¤æµç¨‹

---

## âœ… æ€»ç»“

**Cookie å«å£«**é€šè¿‡ä»¥ä¸‹è®¾è®¡å®ç°äº†æ— ç¼çš„ Cookie ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š

1. **å¯åŠ¨é˜¶æ®µ**ï¼šé™é»˜é¢„æå–ï¼ŒBest-Effort ç­–ç•¥
2. **ä¸‹è½½é˜¶æ®µ**ï¼šç»Ÿä¸€æ–‡ä»¶è·¯å¾„ï¼Œæé€Ÿå¯åŠ¨
3. **å®¹é”™é˜¶æ®µ**ï¼šæ™ºèƒ½æ£€æµ‹ + å‹å¥½ä¿®å¤ï¼Œè‡ªåŠ¨é‡è¯•

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… ç”¨æˆ·ä½“éªŒæµç•…ï¼ˆæ— é¢‘ç¹ UAC å¼¹çª—ï¼‰
- âœ… æ•…éšœè‡ªæ„ˆèƒ½åŠ›å¼ºï¼ˆè‡ªåŠ¨æ£€æµ‹ + ä¿®å¤ï¼‰
- âœ… æ¶æ„æ¸…æ™°ï¼ˆå•ä¾‹æ¨¡å¼ + ç»Ÿä¸€æ–‡ä»¶ï¼‰
- âœ… å¯æ‰©å±•æ€§å¥½ï¼ˆæ”¯æŒå¤šè´¦æˆ·ã€å¥åº·æ£€æŸ¥ç­‰ï¼‰

**ä¸åŸéœ€æ±‚çš„å¯¹æ¯”**ï¼š

| éœ€æ±‚ | å®ç°æ–¹å¼ | çŠ¶æ€ |
|------|---------|------|
| å¯åŠ¨æ—¶é™é»˜æå– | `silent_refresh_on_startup()` | âœ… å®Œæˆ |
| ç»Ÿä¸€æ–‡ä»¶ç®¡ç† | `bin/cookies.txt` | âœ… å®Œæˆ |
| ä¸‹è½½æ—¶è¿‡æœŸæ£€æµ‹ | `detect_cookie_error()` | âœ… å®Œæˆ |
| ç”¨æˆ·æˆæƒä¿®å¤ | `CookieRepairDialog` + UAC | âœ… å®Œæˆ |
| è‡ªåŠ¨é‡è¯• | ä¿®å¤æˆåŠŸå 2 ç§’é‡è¯• | âœ… å®Œæˆ |

---

## ğŸ‰ ä½¿ç”¨ç¤ºä¾‹

### ç”¨æˆ·è§†è§’

1. **é¦–æ¬¡ä½¿ç”¨**
   - æ‰“å¼€åº”ç”¨ â†’ è¿›å…¥è®¾ç½® â†’ é€‰æ‹©"Edge æµè§ˆå™¨"
   - å…³é—­åº”ç”¨é‡æ–°æ‰“å¼€ â†’ Cookie è‡ªåŠ¨æå–ï¼ˆåå°æ— æ„ŸçŸ¥ï¼‰

2. **æ­£å¸¸ä¸‹è½½**
   - ç²˜è´´ URL â†’ ç‚¹å‡»ä¸‹è½½ â†’ ç«‹å³å¼€å§‹ï¼ˆæ— ç­‰å¾…ï¼‰

3. **Cookie å¤±æ•ˆ**
   - ä¸‹è½½å¤±è´¥ â†’ å¼¹å‡ºå¯¹è¯æ¡† â†’ ç‚¹å‡»"è‡ªåŠ¨ä¿®å¤"
   - è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼ˆå¦‚éœ€è¦ï¼‰â†’ ä¿®å¤æˆåŠŸ â†’ è‡ªåŠ¨ç»§ç»­ä¸‹è½½

### å¼€å‘è€…è§†è§’

```python
# è·å– Cookie è·¯å¾„ï¼ˆä¾› yt-dlp ä½¿ç”¨ï¼‰
from fluentytdl.core.cookie_sentinel import cookie_sentinel
cookie_path = cookie_sentinel.get_cookie_file_path()
# â†’ "D:/YouTube/FluentYTDL/bin/cookies.txt"

# æ‰‹åŠ¨åˆ·æ–°ï¼ˆè®¾ç½®é¡µé¢ï¼‰
success, msg = cookie_sentinel.force_refresh_with_uac()
if success:
    print(f"âœ… {msg}")

# æ£€æµ‹é”™è¯¯
stderr = "ERROR: Sign in to confirm your age"
if cookie_sentinel.detect_cookie_error(stderr):
    # è§¦å‘ä¿®å¤æµç¨‹
    ...
```

---

**å®ç°å®Œæˆåº¦ï¼š100%** ğŸ¯

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼Œå¯ç›´æ¥é›†æˆåˆ° FluentYTDL é¡¹ç›®ä¸­ä½¿ç”¨ã€‚
